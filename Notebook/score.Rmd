# Scores

As a measure of the ability to make correct predictions of domain expert annotations we used the "F-score" defined as the harmonic mean of precision and recall: $F = 2 * (precision * recall) / (precision + recall)$).
This score was computed on 300 abstracts (100 of which were not disculosed to avoid overfitting) with about xxxx entities to correctly identify from a dictionary with xxxx labels. 

```{r}
baseline <- 0.792867
target <- 0.817866
winner <- 0.843962
```

The baseline F-score achieved by NIH researchers was `r baseline`. We set up a hard-to-reach F-score target for the race competition which was `r target` (about a `r round(100*target/baseline - 100)` percent increase of the baseline). The winner achieved a score of `r winner`. This represents  a `r 100*(winner - baseline)` percentage points increase compared to the baseline which can be regarded as a very remarkable improvement (more than `r round(100*winner/baseline - 100)` percent).


Figure below shows the provisional scores over the submission time. The left panel shows the raw scores that are very volitile because some preliminary submissions failed to compile or encountered other issues that either terminated the program resulting in a zero or lead to very low scores. This high volatility, however, does not reflect genuine variation in the quality of submissions. The right panel shows the scores capped from [below to reduce volatility due to experimentation with imperfect solutions]. 


```{r, message=FALSE}
# Load libraries
require(races)
require(stargazer)
# require(mgcv)
# require(arm)

# Load Data
data(races)
data(scores)

# Merge
dat <- merge(scores, races[, c('coder_id','treatment','room')], by='coder_id')
dat <- dat[order(dat$timestamp), ]

attach(dat)
provisional <- provisional/1e6
final <- final/1e6
hours <- as.numeric(difftime(timestamp, min(timestamp), unit='hours'))

# New variable
last_submission <- ave(submission, coder_id, FUN=max)
provisional.cap <- ifelse(provisional<baseline, baseline, provisional)
final.cap <- ifelse(final<baseline, baseline, final)


# General plot
par(mfrow=c(1, 2))
plot(aggregate(final ~ hours, FUN=mean), type='l', lwd=2, col=gray(.85))
plot(aggregate(final.cap ~ hours, FUN=mean), type='l', lwd=2, col=gray(.85))
abline(h=target, lty=2, col=2)

# Add winner dots

winners <- function() { 
	out <- matrix(ncol=2, nrow=3)
	rownames(out) <- levels(treatment)
	colnames(out) <- c("hour","final")
	w <- head(which(final>target & treatment=='race'), 1)
	out[1, ] <-  c(hours[w], final[w])
	final.max <- tapply(final, treatment, FUN=max, na.rm=TRUE)
	w <- which(final==final.max['tournament'])
	out[2, ] <- c(hours[w], final[w])
	w <- which(final==final.max['reserve'])
	out[3, ] <- c(hours[w], final[w])
	out
}
# points(winners())

# By treatment
x <- aggregate(provisional.cap ~ round(hours) + treatment, FUN=mean)
index <- split(1:nrow(x), x[, 2])
par(mfrow=c(1, 3))
for (i in 1:3) {
	plot(x[index[[i]], -2], ylim=range(x[, 3]), type='l', lwd=2, col=gray(.85))
	title(names(index)[i])
	abline(h=target, lty=2, col=2)
}

# plot(aggregate(provisional.cap ~ round(hours), FUN=mean), type='l', lwd=2, col=gray(.85))
# points(aggregate(provisional ~ round(hours), FUN=mean))


# By treatment
i <- split(1:nrow(dat), treatment)
xlim <- range(timestamp)
ylim <- range(provisional.cap)

max.score <- function(x) {
	n <- length(x)
	y <- numeric(n)
	for (i in 1:n) y[i] <- max(x[1:i])
	return(y)
}


plot.scores <- function(index, add=FALSE, ...) {
	x <- timestamp[index]
	y <- provisional.cap[index]
	if (add==FALSE) plot(NA, NA, xlim=xlim, ylim=ylim)
	points(x, y, pch="-", ...)
	abline(h=target, lty=2, col=2)
	lines(smooth.spline(x, y, df=4))
	abline(lm(y ~ x))
	lines(x, max.score(y))
}

par(mfrow=c(1, 3))
for (k in levels(treatment)) {
	plot.scores(i[[k]])
	title(k)
}



 

# submission.cap <- ifelse(submission>15, 15, submission)
# boxplot(provisional/1e6 ~ submission.cap, pch='-')
# abline(h=0.8, col=2)

# Time series
l <- split(dat, paste(treatment, room))
xlim <- range(timestamp)
ylim <- c(0.7, 0.9)
par(mfrow=c(5,5), mar=c(2,2,1,1))
sapply(l, function(x)plot(x$timestamp, x$provisional/1e6, xlim=xlim, ylim=ylim, pch=16))

```